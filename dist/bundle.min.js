(()=>{function M(){return Array.from({length:4},()=>Math.floor(Math.random()*256))}function R(t,e){return t.map((n,a)=>n^e[a%4])}async function U(t){try{if(!t||t.length===0)return new Uint8Array(0);if(typeof CompressionStream<"u"){let e=new ReadableStream({start(l){l.enqueue(t),l.close()}}),n=new CompressionStream("deflate"),o=e.pipeThrough(n).getReader(),s=[];for(;;){let{value:l,done:i}=await o.read();if(i)break;s.push(l)}let c=s.reduce((l,i)=>l+i.length,0),r=new Uint8Array(c),p=0;for(let l of s)r.set(l,p),p+=l.length;return r}else{let e=new TextDecoder().decode(t);if(!e||e.length===0)return new Uint8Array(0);let n="",a=1,o=e[0];for(let s=1;s<e.length;s++)e[s]===o?a++:(a>1?n+=a+o:n+=o,o=e[s],a=1);return a>1?n+=a+o:n+=o,new TextEncoder().encode(n)}}catch(e){return console.warn("Compression failed, using original payload:",e),t}}function O(t){switch(t){case 0:return"Continuation";case 1:return"Text";case 2:return"Binary";case 8:return"Close";case 9:return"Ping";case 10:return"Pong";default:return"Unknown"}}function j(t){return t.map(e=>e.toString(16).padStart(2,"0")).join(" ")}async function $(t){let{payload:e,opcode:n=1,fin:a=!0,rsv1:o=!1,rsv2:s=!1,rsv3:c=!1,masked:r=!0,compressed:p=!1,closeCode:l=null}=t;if(!e)throw new Error("Payload is required");if(e.length>Number.MAX_SAFE_INTEGER)throw new Error("Payload too large for JavaScript");let i=e,h=null;if(p&&(n===1||n===2)){let m=e.length;i=await U(e);let g=i.length;h={originalLength:m,compressedLength:g,compressionRatio:((m-g)/m*100).toFixed(1)}}let d=[],f=[],v=a?128:0,S=o?64:0,x=s?32:0,E=c?16:0,I=n&15;d.push(v|S|x|E|I),f.push({kind:"header",bytes:[v|S|x|E|I],description:"Frame Header",details:{fin:a,rsv1:o,rsv2:s,rsv3:c,opcode:n,finBit:a?"1":"0",rsv1Bit:o?"1":"0",rsv2Bit:s?"1":"0",rsv3Bit:c?"1":"0",opcodeBits:n.toString(2).padStart(4,"0"),opcodeName:O(n),combinedByte:(v|S|x|E|I).toString(16).padStart(2,"0")}});let D=n>=8,A=i.length;if(r&&(A|=128),i.length<126)d.push(A),f.push({kind:"length",bytes:[A],description:"Payload Length",details:{masked:r,payloadLength:i.length,lengthBits:i.length.toString(2).padStart(7,"0")}});else if(i.length<65536){d.push(126),d.push(i.length>>8&255),d.push(i.length&255);let m=[i.length>>8&255,i.length&255];f.push({kind:"extendedLength",bytes:[126,...m],description:"Extended Payload Length (16 bits)",details:{masked:r,payloadLength:i.length,asBytes:j(m)}})}else{d.push(127);let m=BigInt(i.length),g=[];for(let b=7;b>=0;b--){let P=Number(m>>BigInt(b*8)&0xffn);d.push(P),g.push(P)}f.push({kind:"extendedLength",bytes:[127,...g],description:D?"Extended Control Frame Length (64-bit)":"Extended Payload Length (64-bit)",details:{masked:r,payloadLength:i.length,asBytes:"64-bit"}})}let k=null;r&&(k=M(),d.push(...k),f.push({kind:"mask",bytes:k,description:"Masking Key",details:{masked:!0,mask:k.map(m=>m.toString(16).padStart(2,"0"))}}));let F=n===8;if((!D||F)&&i.length>0){let m=Array.from(i);if(r&&(m=R(m,k)),F&&l){let g=m.slice(0,2),b=m.slice(2);d.push(...g),f.push({kind:"closeCode",bytes:g,originalBytes:Array.from(i.slice(0,2)),description:"Close Code",details:{closeCode:!0,closeCodeValue:l,payloadLength:g.length,masked:r}}),b.length>0&&(d.push(...b),f.push({kind:"closeReason",bytes:b,originalBytes:Array.from(i.slice(2)),description:"Close Reason",details:{closeReason:!0,payloadLength:b.length,originalBytes:Array.from(e.slice(2)),masked:r}}))}else d.push(...m),f.push({kind:"payload",bytes:m,originalBytes:Array.from(i),description:"Payload",details:{payload:!0,payloadLength:m.length,originalLength:e.length,originalBytes:Array.from(e),masked:r,compressionInfo:h}})}return{frame:d,frameSections:f,details:{fin:a,rsv1:o,rsv2:s,rsv3:c,opcode:n,masked:r,mask:k,payloadLength:i.length,originalPayloadLength:e.length,compressed:p&&n===1}}}var y=null,C=-1;function L(t,e,n){let a=document.createElement("div");a.className="checkbox-wrapper";let o=document.createElement("input");o.type="checkbox",o.id=n,o.className="checkbox-input",o.checked=e;let s=document.createElement("label");return s.htmlFor=n,s.className="checkbox-label",s.textContent=t,a.append(o,s),{checkbox:o,container:a}}function N(t){switch(t.kind){case"closeCode":return"#dc2626";case"closeReason":return"#059669";case"payload":return"#1e3a8a";case"mask":return"#7c3aed";case"extendedLength":return"#581c87";case"header":return"#0891b2";case"length":return"#ea580c";default:return"b91c1c"}}function V(t){let e=document.createElement("div");return e.className="hex-display",t.forEach((n,a)=>{let o=document.createElement("div");o.className="hex-element",o.style.backgroundColor="#374151";let s=n.bytes.map(p=>p.toString(16).padStart(2,"0")).join(" ");o.textContent=s;let c=()=>{C=a,B(),w(),o.style.backgroundColor=N(n)},r=()=>{C=-1,B(),w(),o.style.backgroundColor="#374151"};o.addEventListener("mouseenter",c),o.addEventListener("mouseleave",r),o.setAttribute("data-element",a),e.append(o)}),{container:e,hexElements:e.querySelectorAll(".hex-element")}}function B(){document.querySelectorAll("[data-element]").forEach(e=>{let n=parseInt(e.getAttribute("data-element")),a=C===n;if(C!==-1&&y&&y.frameSections)if(a){let o=y.frameSections[n];o&&(e.style.backgroundColor=N(o),e.style.fontWeight="bold",e.style.color="#e2e8f0")}else e.style.backgroundColor="#374151",e.style.fontWeight="normal",e.style.color="#e2e8f0";else e.style.backgroundColor="#374151",e.style.fontWeight="normal",e.style.color="#e2e8f0"})}function w(){document.querySelectorAll(".frame-section").forEach((e,n)=>{let a=C===n;if(C!==-1&&y&&y.frameSections)if(a){let o=y.frameSections[n];o&&(e.style.backgroundColor=N(o),e.style.border=`1px solid ${N(o)}`,e.style.opacity="1")}else e.style.backgroundColor="#374151",e.style.border="1px solid #334155",e.style.opacity="0.7";else e.style.backgroundColor="#374151",e.style.border="1px solid #334155",e.style.opacity="0.7"})}function W(t){let e=document.createElement("div");e.className="details-container";let n=document.createElement("div");if(n.className="detail-item",n.textContent=`Close Code: ${t.details.closeCodeValue}`,e.append(n),t.details.masked){let o=document.createElement("div");o.className="detail-item",o.style.fontSize="11px",o.style.color="#94a3b8",o.style.fontStyle="italic",o.textContent="Note: The close code is masked.",e.append(o)}let a=document.createElement("div");return a.className="detail-item small",a.textContent=`${t.details.payloadLength} bytes`,e.append(a),e}function q(t){let e=document.createElement("div");e.className="details-container";let n="";try{n=new TextDecoder().decode(Uint8Array.from(t.details.originalBytes||t.bytes))}catch(s){console.error("Failed to decode close reason:",s),n="[Invalid UTF-8]"}let a=document.createElement("div");if(a.className="detail-item",a.textContent=`Close Reason: "${n}"`,e.append(a),t.details.masked&&t.details.originalBytes){let s=document.createElement("div");s.className="detail-item",s.style.fontSize="11px",s.style.color="#94a3b8",s.style.fontStyle="italic";let c=t.details.originalBytes.slice(0,4).map(p=>p.toString(16).padStart(2,"0")).join(" "),r=t.bytes.slice(0,4).map(p=>p.toString(16).padStart(2,"0")).join(" ");s.textContent="Note: The close reason is masked.",e.append(s)}let o=document.createElement("div");return o.className="detail-item small",o.textContent=`${t.details.payloadLength} bytes`,e.append(o),e}function G(t){let e=document.createElement("div");e.className="details-container";let n="";try{n=new TextDecoder().decode(Uint8Array.from(t.details.originalBytes||t.originalBytes||t.bytes))}catch(o){console.warn("Failed to decode payload:",o),n="[Invalid UTF-8]"}let a=document.createElement("div");if(a.className="detail-item payload-plaintext",a.style.overflowX="hidden",a.style.maxHeight="200px",a.style.overflowY="auto",a.textContent=`"${n}"`,e.append(a),t.details.masked&&t.details.originalBytes){let o=document.createElement("div");o.className="detail-item",o.style.fontSize="11px",o.style.color="#94a3b8",o.style.fontStyle="italic";let s=null;if(y?.frameSections){let r=y.frameSections.find(p=>p.details?.mask);r&&(s=r.details.mask)}let c="";if(s){let r=t.details.originalBytes.slice(0,4).map(i=>i.toString(16).padStart(2,"0")).join(" "),p=t.bytes.slice(0,4).map(i=>i.toString(16).padStart(2,"0")).join(" "),l=s.slice(0,4).map(i=>i.toString(16).padStart(2,"0")).join(" ");c+=`Original: ${r}${t.details.originalBytes.length>4?"...":""}<br>`,c+=`Mask:     ${l}<br>`,c+=`Masked:   ${p}${t.bytes.length>4?"...":""}`}else{let r=t.details.originalBytes.slice(0,4).map(l=>l.toString(16).padStart(2,"0")).join(" "),p=t.bytes.slice(0,4).map(l=>l.toString(16).padStart(2,"0")).join(" ");c+=`Masked:   ${p}${t.bytes.length>4?"...":""}<br>`,c+="Mask:     [key not found]<br>",c+=`Original: ${r}${t.details.originalBytes.length>4?"...":""}`}o.innerHTML=c,e.append(o)}if(t.details.compressionInfo){let o=Array.from(t.bytes).map(r=>r.toString(16).padStart(2,"0")).join(" "),s=document.createElement("div");s.className="detail-item",s.textContent=`Compressed (hex): ${o}`,e.append(s);let c=document.createElement("div");c.className="detail-item",c.textContent=`${t.details.compressionInfo.compressedLength} bytes (${t.details.compressionInfo.compressionRatio}% compression)`,e.append(c)}else{let o=document.createElement("div");o.className="detail-item small",o.textContent=`${t.details.payloadLength} bytes`,e.append(o)}return e}function z(t){let e=document.createElement("div");e.className="details-container";let n=document.createElement("div");return n.className="detail-item",n.textContent=`${t.details.mask.join(" ")}`,e.append(n),e}function Y(t){let e=document.createElement("div");e.className="details-container";let n=document.createElement("div");n.className="detail-item",n.textContent=`0x${t.details.combinedByte}`,e.append(n);let a=document.createElement("div");a.className="bit-breakdown";let o=document.createElement("div");o.className="field-labels";let s=["FIN","RSV1","RSV2","RSV3","Opcode","Opcode","Opcode","Opcode"];for(let l=7;l>=0;l--){let i=document.createElement("div");i.className="field-label",s[7-l]==="Opcode"?l===1&&(i.textContent="Opcode (4 bits)",i.classList.add("op-label")):i.textContent=s[7-l],o.append(i)}a.append(o);let c=document.createElement("div");c.className="bit-grid";for(let l=7;l>=0;l--){let i=document.createElement("div");i.className="bit-position",i.textContent=`${l}`,c.append(i)}a.append(c);let r=document.createElement("div");r.className="bit-values";let p=parseInt(t.details.combinedByte,16);for(let l=7;l>=0;l--){let i=document.createElement("div");i.className="bit-value";let h=p>>l&1;i.textContent=`${h}`,i.style.backgroundColor=h?"#0891b2":"#374151",r.append(i)}return a.append(r),e.append(a),e}function K(t){let e=document.createElement("div");e.className="details-container";let n=document.createElement("div");return n.className="detail-item",t.kind==="extendedLength"?n.textContent=`${t.details.payloadLength} bytes (${t.details.asBytes})`:n.textContent=`${t.details.payloadLength} bytes`,e.append(n),e}function X(t){let e=document.getElementById("frameDetails");e&&(e.innerHTML="",t.forEach((n,a)=>{let o=document.createElement("div");o.className="frame-section",o.setAttribute("data-frame-section",a),o.style.backgroundColor="#374151",o.style.border="1px solid #334155",o.style.opacity="0.7";let s=document.createElement("div");if(s.className="frame-section-title",s.textContent=n.description,o.append(s),o.addEventListener("mouseenter",()=>{C=a,B(),w()}),o.addEventListener("mouseleave",()=>{C=-1,B(),w()}),n.details){let c;n.details.closeCode?c=W(n):n.details.closeReason?c=q(n):n.details.payload?c=G(n):n.details.mask?c=z(n):n.description.includes("Frame Header")?c=Y(n):c=K(n),o.append(c)}e.append(o)}))}function H(){let t=document.getElementById("opSelect"),e=document.getElementById("textInput"),n=document.getElementById("compressCheckbox"),a=document.getElementById("closeCodeContainer");if(!t||!e||!n||!a)return;let o=parseInt(t.value),s=o>=8,c=o===8;if(a.style.display=c?"flex":"none",s&&!c){e.disabled=!0,e.classList.add("disabled"),e.placeholder="Ping/Pong frames don't have a payload",e.value="",n.disabled=!0,n.parentElement.classList.add("disabled");let r=document.getElementById("finCheckbox");r&&(r.checked=!0,r.disabled=!0,r.parentElement.classList.add("disabled"))}else{e.disabled=!1,e.classList.remove("disabled"),c?(e.placeholder="Close reason (optional)",e.value=""):(e.placeholder="Your message goes here",e.value=""),n.disabled=!1,n.parentElement.classList.remove("disabled");let r=document.getElementById("finCheckbox");r&&(r.disabled=!1,r.parentElement.classList.remove("disabled"))}}async function T(){let t=document.getElementById("textInput"),e=document.getElementById("output"),n=document.getElementById("frameDetails"),a=document.getElementById("opSelect"),o=document.getElementById("closeCodeSelect"),s=document.getElementById("finCheckbox"),c=document.getElementById("maskCheckbox"),r=document.getElementById("compressCheckbox");if(!t||!a||!s||!c||!r||!e){console.error("UI elements not found");return}n.innerHTML="";try{let p=t.value||"",l=parseInt(a.value)||1,i=l===8,h=l<8;if(h&&p.length>1e4)throw new Error("Plaintext input is too long. Maximum length is 10,000 characters.");let u,d=null;if(i){if(d=parseInt(o.value)||1e3,d<1e3||d>1015)throw new Error("Invalid close code. Must be between 1000-1015.");let x=new Uint8Array(2);if(x[0]=d>>8&255,x[1]=d&255,p!==""){let E=new TextEncoder().encode(p);u=new Uint8Array(2+E.length),u.set(x,0),u.set(E,2)}else u=x}else h?u=new TextEncoder().encode(p):u=new Uint8Array(0);let f={payload:u,opcode:l,fin:s.checked,rsv1:r.checked,rsv2:!1,rsv3:!1,masked:c.checked,compressed:r.checked,closeCode:d},v=await $(f);y=v,e.innerHTML="";let S=V(v.frameSections);e.append(S.container),X(v.frameSections)}catch(p){let l=document.createElement("div");l.className="error-message",l.textContent=p.message,n.append(l)}}var _=[{value:"1",text:"Text (0x1)",description:"UTF-8 encoded text data"},{value:"2",text:"Binary (0x2)",description:"Binary data"},{value:"8",text:"Close (0x8)",description:"Connection close with optional code and reason"},{value:"9",text:"Ping (0x9)",description:"Ping (no payload)"},{value:"10",text:"Pong (0xA)",description:"Pong (no payload)"}],J=[{value:"1000",text:"1000 Normal Closure",description:"Normal closure, meaning that the purpose for which the connection was established has been fulfilled."},{value:"1001",text:"1001 Going Away",description:'An endpoint is "going away", such as a server going down or a browser having navigated away from a page.'},{value:"1002",text:"1002 Protocol Error",description:"An endpoint is terminating the connection due to a protocol error."},{value:"1003",text:"1003 Unsupported Data",description:"An endpoint is terminating the connection because it has received a type of data it cannot accept."},{value:"1005",text:"1005 No Status Received",description:"No status code was actually present."},{value:"1006",text:"1006 Abnormal Closure",description:"Abnormal closure, meaning the connection was lost without a close frame being received."},{value:"1007",text:"1007 Invalid frame payload data",description:"An endpoint is terminating the connection because it has received data within a message that was not consistent with the type of the message."},{value:"1008",text:"1008 Policy Violation",description:'An endpoint is terminating the connection because it has received a message that "violates its policy".'},{value:"1009",text:"1009 Message too big",description:"An endpoint is terminating the connection because it has received a message that is too big for it to process."},{value:"1010",text:"1010 Extension Required",description:"An endpoint (client) is terminating the connection because it has expected the server to negotiate one or more extension."},{value:"1011",text:"1011 Internal Error",description:"A server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request."},{value:"1015",text:"1015 TLS Handshake",description:"The connection was closed due to a failure to perform a TLS handshake."}],Q=document.getElementById("encoder");function Z(){let t=document.createElement("div");t.className="container",t.id="container";let e=document.createElement("div");e.className="left-panel",e.id="inputPanel";let n=document.createElement("div");return n.className="right-panel",n.id="rightPanel",t.append(e),t.append(n),{container:t,leftPanel:e,rightPanel:n}}function ee(){let t=document.createElement("textarea");return t.className="text-input",t.id="textInput",t.placeholder="Your message goes here",t.addEventListener("focus",()=>t.style.borderColor="#3b82f6"),t.addEventListener("blur",()=>t.style.borderColor="#334155"),{input:t}}function te(){let t=document.createElement("div");t.className="options";let e=document.createElement("label");e.textContent="Frame type",e.htmlFor="opSelect",e.className="op-label";let n=document.createElement("select");n.className="op-select",n.id=e.htmlFor,n.addEventListener("change",H),_.forEach(u=>{let d=document.createElement("option");d.value=u.value,d.textContent=u.text,d.title=u.description,n.append(d)});let a=document.createElement("div");a.className="op-container",a.id="opContainer",a.append(e,n);let o=document.createElement("label");o.textContent="Close code",o.htmlFor="closeCodeSelect",o.className="close-code-label",o.id="closeCodeLabel";let s=document.createElement("select");s.className="close-code-select",s.id=o.htmlFor,J.forEach(u=>{let d=document.createElement("option");d.value=u.value,d.textContent=u.text,d.title=u.description,s.append(d)});let c=document.createElement("div");c.className="close-code-container",c.id="closeCodeContainer",c.style.display="none",c.append(o,s);let r=document.createElement("div");r.className="checkbox-container";let p=L("FIN bit",!0,"finCheckbox"),l=L("Masked frame",!0,"maskCheckbox"),i=L("Enable compression",!1,"compressCheckbox");r.append(p.container,l.container,i.container);let h=document.createElement("button");return h.textContent="Generate WebSocket Frame",h.className="generate-btn",h.onclick=T,t.append(a),t.append(c),t.append(r),t.append(h),{options:t}}function ne(){let t=document.createElement("div");t.className="output",t.id="output";let e=document.createElement("div");return e.className="output-placeholder",e.textContent="Output appears here",t.append(e),{output:t}}function oe(){let t=document.createElement("div");t.id="frameDetails",t.className="frame-details";let e=document.createElement("div");return e.className="details-placeholder",e.textContent="Frame details appear here",t.append(e),{details:t}}function ae(){let{container:t,leftPanel:e,rightPanel:n}=Z(),{input:a}=ee(),{output:o}=ne(),{options:s}=te(),{details:c}=oe();e.append(a),e.append(s),e.append(o),n.append(c),Q.append(t)}ae();})();
