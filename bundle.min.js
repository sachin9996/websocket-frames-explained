(()=>{function V(){return Array.from({length:4},()=>Math.floor(Math.random()*256))}function O(t,e){return t.map((n,o)=>n^e[o%4])}async function G(t){try{if(!t||t.length===0)return new Uint8Array(0);if(typeof CompressionStream<"u"){let e=new ReadableStream({start(m){m.enqueue(t),m.close()}}),n=new CompressionStream("deflate"),a=e.pipeThrough(n).getReader(),s=[];for(;;){let{value:m,done:d}=await a.read();if(d)break;s.push(m)}let i=s.reduce((m,d)=>m+d.length,0),r=new Uint8Array(i),u=0;for(let m of s)r.set(m,u),u+=m.length;return r}else{let e=new TextDecoder().decode(t);if(!e||e.length===0)return new Uint8Array(0);let n="",o=1,a=e[0];for(let s=1;s<e.length;s++)e[s]===a?o++:(o>1?n+=o+a:n+=a,a=e[s],o=1);return o>1?n+=o+a:n+=a,new TextEncoder().encode(n)}}catch(e){return console.warn("Compression failed, using original payload:",e),t}}function W(t){switch(t){case 0:return"Continuation";case 1:return"Text";case 2:return"Binary";case 8:return"Close";case 9:return"Ping";case 10:return"Pong";default:return"Unknown"}}function S(t){return t.map(e=>e.toString(16).padStart(2,"0")).join(" ")}async function T(t){let{payload:e,opcode:n=1,fin:o=!0,rsv1:a=!1,rsv2:s=!1,rsv3:i=!1,masked:r=!0,compressed:u=!1,closeCode:m=null}=t;if(!e)throw new Error("Payload is required");if(e.length>Number.MAX_SAFE_INTEGER)throw new Error("Payload too large for JavaScript");let d=e,p=null;if(u&&(n===0||n===1||n===2)){let f=e.length;d=await G(e);let x=d.length;p={originalLength:f,compressedLength:x,compressionRatio:((f-x)/f*100).toFixed(1)}}let l=[],y=o?128:0,h=a?64:0,g=s?32:0,b=i?16:0,N=n&15,$=y|h|g|b|N;l.push({kind:"header",bytes:[$],description:"Header",details:{fin:o,rsv1:a,rsv2:s,rsv3:i,opcode:n,finBit:o?"1":"0",rsv1Bit:a?"1":"0",rsv2Bit:s?"1":"0",rsv3Bit:i?"1":"0",opcodeBits:n.toString(2).padStart(4,"0"),opcodeName:W(n),byteString:S([$])}});let H=n>=8,P=d.length;if(r&&(P|=128),d.length<126)l.push({kind:"length",bytes:[P],description:"Mask indicator + payload Length",details:{masked:r,payloadLength:d.length,byteString:S([P])}});else if(d.length<65536){let f=126;r&&(f|=128);let x=[d.length>>8&255,d.length&255];l.push({kind:"extendedLengthInfo",bytes:[f],description:"Mask indicator + payload length info",details:{masked:r,firstSevenLenBits:126,byteString:S([f])}},{kind:"extendedLength",bytes:x,description:"Payload length (16 bits)",details:{masked:r,payloadLength:d.length}}),l.push()}else{let f=127;r&&(f|=128);let x=BigInt(d.length),C=[];for(let A=7;A>=0;A--){let U=Number(x>>BigInt(A*8)&0xffn);C.push(U)}l.push({kind:"extendedLengthInfo",bytes:[f],description:"Mask indicator + payload length info",details:{masked:r,firstSevenLenBits:127,byteString:S([f])}},{kind:"extendedLength",bytes:C,description:"Payload length (64-bit)",details:{masked:r,payloadLength:d.length}})}let k=null;r&&(k=V(),l.push({kind:"maskingKey",bytes:k,description:"Masking Key",details:{masked:!0,mask:k.map(f=>f.toString(16).padStart(2,"0"))}}));let D=n===8;if((!H||D)&&d.length>0){let f=Array.from(d);if(r&&(f=O(f,k)),D&&m){let x=f.slice(0,2),C=f.slice(2);l.push({kind:"closeCode",bytes:x,originalBytes:Array.from(d.slice(0,2)),description:"Close Code",details:{closeCode:!0,closeCodeValue:m,payloadLength:x.length,masked:r}}),C.length>0&&l.push({kind:"closeReason",bytes:C,originalBytes:Array.from(d.slice(2)),description:"Close Reason",details:{closeReason:!0,payloadLength:C.length,originalBytes:Array.from(e.slice(2)),masked:r}})}else l.push({kind:"payload",bytes:f,originalBytes:Array.from(d),description:"Payload",details:{payload:!0,payloadLength:f.length,originalLength:e.length,originalBytes:Array.from(e),masked:r,compressionInfo:p}})}return{frameSections:l,details:{fin:o,rsv1:a,rsv2:s,rsv3:i,opcode:n,masked:r,mask:k,payloadLength:d.length,originalPayloadLength:e.length}}}var v=null,E=-1;function I(t,e,n){let o=document.createElement("div");o.className="checkbox-wrapper";let a=document.createElement("input");a.type="checkbox",a.id=n,a.className="checkbox-input",a.checked=e;let s=document.createElement("label");return s.htmlFor=n,s.className="checkbox-label",s.textContent=t,s.title="FOO",o.append(a,s),{checkbox:a,container:o}}function L(t){switch(t.kind){case"closeCode":return"#dc2626";case"closeReason":return"#c756c3";case"payload":return"#059669";case"maskingKey":return"#7c3aed";case"extendedLengthInfo":return"#581c87";case"header":return"#0891b2";case"length":case"extendedLength":return"#ea580c";default:return"b91c1c"}}function j(t){let e=document.createElement("div");return e.className="hex-display",t.forEach((n,o)=>{let a=document.createElement("div");a.className="hex-element",a.style.backgroundColor="#374151";let s=n.bytes.map(u=>u.toString(16).padStart(2,"0")).join(" ");a.textContent=s;let i=()=>{E=o,w(),B(),a.style.backgroundColor=L(n)},r=()=>{E=-1,w(),B(),a.style.backgroundColor="#374151"};a.addEventListener("mouseenter",i),a.addEventListener("mouseleave",r),a.setAttribute("data-element",o),e.append(a)}),{container:e,hexElements:e.querySelectorAll(".hex-element")}}function w(){document.querySelectorAll("[data-element]").forEach(e=>{let n=parseInt(e.getAttribute("data-element")),o=E===n;if(E!==-1&&v&&v.frameSections)if(o){let a=v.frameSections[n];a&&(e.style.backgroundColor=L(a),e.style.fontWeight="bold",e.style.color="#e2e8f0")}else e.style.backgroundColor="#374151",e.style.fontWeight="normal",e.style.color="#e2e8f0";else e.style.backgroundColor="#374151",e.style.fontWeight="normal",e.style.color="#e2e8f0"})}function B(){document.querySelectorAll(".frame-section").forEach((e,n)=>{let o=E===n;if(E!==-1&&v&&v.frameSections)if(o){let a=v.frameSections[n];a&&(e.style.backgroundColor=L(a),e.style.border=`1px solid ${L(a)}`,e.style.opacity="1")}else e.style.backgroundColor="#374151",e.style.border="1px solid #334155",e.style.opacity="0.7";else e.style.backgroundColor="#374151",e.style.border="1px solid #334155",e.style.opacity="0.7"})}function q(t){let e=document.createElement("div");e.className="details-container";let n=document.createElement("div");if(n.className="frame-part",n.textContent=`Close Code: ${t.details.closeCodeValue}`,e.append(n),t.details.masked){let a=document.createElement("div");a.className="frame-part",a.style.fontSize="11px",a.style.color="#94a3b8",a.style.fontStyle="italic",a.textContent="Note: The close code is masked.",e.append(a)}let o=document.createElement("div");return o.className="frame-part small",o.textContent=`${t.details.payloadLength} ${t.details.payloadLength===1?"byte":"bytes"}`,e.append(o),e}function K(t){let e=document.createElement("div");e.className="details-container";let n="";try{n=new TextDecoder().decode(Uint8Array.from(t.details.originalBytes||t.bytes))}catch(s){console.error("Failed to decode close reason:",s),n="[Invalid UTF-8]"}let o=document.createElement("div");if(o.className="frame-part",o.textContent=`Close Reason: "${n}"`,e.append(o),t.details.masked&&t.details.originalBytes){let s=document.createElement("div");s.className="frame-part",s.style.fontSize="11px",s.style.color="#94a3b8",s.style.fontStyle="italic",s.textContent="Note: The close reason is masked.",e.append(s)}let a=document.createElement("div");return a.className="frame-part small",a.textContent=`${t.details.payloadLength} bytes`,e.append(a),e}function z(t){let e=document.createElement("div");e.className="details-container";let n="";try{n=new TextDecoder().decode(Uint8Array.from(t.details.originalBytes||t.originalBytes||t.bytes))}catch(a){console.warn("Failed to decode payload:",a),n="[Invalid UTF-8]"}let o=document.createElement("div");if(o.className="frame-part payload-plaintext",o.style.overflowX="hidden",o.style.maxHeight="200px",o.style.overflowY="auto",o.textContent=n,e.append(o),t.details.masked&&t.details.originalBytes){let a=document.createElement("div");a.className="frame-part",a.style.fontSize="11px",a.style.color="#94a3b8",a.style.fontStyle="italic";let s=null;if(v?.frameSections){let c=v.frameSections.find(l=>l.details?.mask);c&&(s=c.details.mask)}if(!s)throw new Error("mask not found");let i=t.details.originalBytes.slice(0,4).map(c=>c.toString(16).padStart(2,"0")).join(" "),r=t.bytes.slice(0,4).map(c=>c.toString(16).padStart(2,"0")).join(" "),u=s.slice(0,4).map(c=>c.toString(16).padStart(2,"0")).join(" "),m=document.createElement("div");m.textContent=`Original: ${i}${t.details.originalBytes.length>4?"...":""}`;let d=document.createElement("div");d.textContent=`Masking key: ${u}`;let p=document.createElement("div");p.textContent=`Masked: ${r}${t.bytes.length>4?"...":""}`,a.append(m,d,p),e.append(a)}if(t.details.compressionInfo){let a=Array.from(t.bytes).map(r=>r.toString(16).padStart(2,"0")).join(" "),s=document.createElement("div");s.className="frame-part",s.textContent=`Compressed (hex): ${a}`,e.append(s);let i=document.createElement("div");i.className="frame-part",i.textContent=`${t.details.compressionInfo.compressedLength} bytes (${t.details.compressionInfo.compressionRatio}% compression)`,e.append(i)}else{let a=document.createElement("div");a.className="frame-part small",a.textContent=`${t.details.payloadLength} bytes`,e.append(a)}return e}function Y(t){let e=document.createElement("div");e.className="details-container";let n=document.createElement("div");return n.className="frame-part",n.textContent=`${t.details.mask.join(" ")}`,e.append(n),e}function X(t){let e=document.createElement("div");e.className="frame-part",e.textContent=`0x${t.details.byteString}`;let n=document.createElement("div");n.className="bit-breakdown";let o=document.createElement("div");o.className="field-labels";let a=["FIN","RSV1","RSV2","RSV3","","","OPCODE (4 bits)",""];for(let h=7;h>=0;h--){let g=document.createElement("div");g.className="field-label",g.textContent=a[7-h],a[7-h]==="OPCODE (4 bits)"&&g.classList.add("opcode"),o.append(g)}let s=document.createElement("div");s.className="bit-grid";for(let h=7;h>=0;h--){let g=document.createElement("div");g.className="bit-position",g.textContent=`${h}`,s.append(g)}let i=document.createElement("div");i.className="bit-values";let r=parseInt(t.details.byteString,16);for(let h=7;h>=0;h--){let g=document.createElement("div");g.className="bit-value";let b=r>>h&1;g.textContent=`${b}`,g.style.backgroundColor=b?"#0891b2":"#374151",i.append(g)}n.append(o,s,i);let u=document.createElement("div");u.className="frame-part";let m=document.createElement("div");m.textContent=`FIN: ${t.details.fin}`;let d=document.createElement("div");d.textContent=`RSV1: ${t.details.rsv1}`;let p=document.createElement("div");p.textContent=`RSV1: ${t.details.rsv2}`;let c=document.createElement("div");c.textContent=`RSV1: ${t.details.rsv3}`;let l=document.createElement("div");l.textContent=`Opcode: ${t.details.opcodeBits} (${t.details.opcodeName})`,u.append(m,d,p,c,l);let y=document.createElement("div");return y.className="details-container",y.append(e,n,u),y}function _(t){let e=document.createElement("div");e.className="frame-part",e.textContent=`0x${t.details.byteString}`;let n=document.createElement("div");n.className="bit-breakdown";let o=document.createElement("div");o.className="field-labels";let a=["MASK","","","LENGTH (7 bits)","","","",""];for(let p=7;p>=0;p--){let c=document.createElement("div");c.className="field-label",c.textContent=a[7-p],a[7-p]==="LENGTH (7 bits)"&&(c.style.width="80px",c.style.marginRight="-30px"),o.append(c)}let s=document.createElement("div");s.className="bit-grid";for(let p=7;p>=0;p--){let c=document.createElement("div");c.className="bit-position",c.textContent=`${p}`,s.append(c)}let i=document.createElement("div");i.className="bit-values";for(let p=7;p>=0;p--){let c=document.createElement("div");c.className="bit-value";let l=t.bytes[0]>>p&1;c.textContent=`${l}`,c.style.backgroundColor=l?"#ea580c":"#374151",i.append(c)}n.append(o,s,i);let r=document.createElement("div");r.className="details-container";let u=document.createElement("div");u.className="frame-part";let m=document.createElement("div");m.textContent=`Masked: ${t.details.masked}`;let d=document.createElement("div");return d.textContent=`Length: ${t.details.payloadLength} ${t.details.payloadLength===1?"byte":"bytes"}`,u.append(m,d),r.append(e,n,u),r}function J(t){let e=document.createElement("div");e.className="frame-part";let n=document.createElement("div");n.textContent=`Length: ${t.details.payloadLength} bytes`,e.append(n);let o=document.createElement("div");return o.className="details-container",o.append(e),o}function Q(t){let e=document.createElement("div");e.className="frame-part",e.textContent=`0x${t.details.byteString}`;let n=document.createElement("div");n.className="bit-breakdown";let o=document.createElement("div");o.className="field-labels";let a=["MASK","","","LENGTH INDICATOR (7 bits)","","","",""];for(let c=7;c>=0;c--){let l=document.createElement("div");l.className="field-label",l.textContent=a[7-c],a[7-c]==="LENGTH INDICATOR (7 bits)"&&(l.style.width="160px"),o.append(l)}let s=document.createElement("div");s.className="bit-grid";for(let c=7;c>=0;c--){let l=document.createElement("div");l.className="bit-position",l.textContent=`${c}`,s.append(l)}let i=document.createElement("div");i.className="bit-values";for(let c=7;c>=0;c--){let l=document.createElement("div");l.className="bit-value";let y=t.bytes[0]>>c&1;l.textContent=`${y}`,l.style.backgroundColor=y?"#581c87":"#374151",i.append(l)}n.append(o,s,i);let r=document.createElement("div");r.className="details-container";let u=document.createElement("div");u.className="frame-part";let m=document.createElement("div");m.textContent=`Masked: ${t.details.masked}`;let d=document.createElement("div");d.textContent=`Length of payload length: ${t.details.firstSevenLenBits===126?"16 bits":"64 bits"}`;let p=document.createElement("div");return p.style.fontStyle="italic",p.style.color="#94a3b8",p.textContent=`This comes from the lower 7 bits being ${t.details.firstSevenLenBits}`,u.append(m,d,p),r.append(e,n,u),r}function Z(t){let e=document.getElementById("frameDetails");e&&(e.innerHTML="",t.forEach((n,o)=>{let a=document.createElement("div");a.className="frame-section",a.setAttribute("data-frame-section",o),a.style.backgroundColor="#374151",a.style.border="1px solid #334155",a.style.opacity="0.7";let s=document.createElement("div");s.className="frame-section-title",s.textContent=n.description,a.append(s),a.addEventListener("mouseenter",()=>{E=o,w(),B()}),a.addEventListener("mouseleave",()=>{E=-1,w(),B()});let i;switch(n.kind){case"closeCode":i=q(n);break;case"closeReason":i=K(n);break;case"payload":i=z(n);break;case"maskingKey":i=Y(n);break;case"header":i=X(n);break;case"length":i=_(n);break;case"extendedLength":i=J(n);break;case"extendedLengthInfo":i=Q(n);break;default:throw new Error(`Unexpected kind ${n.kind}`)}a.append(i),e.append(a)}))}function F(){let t=document.getElementById("opSelect"),e=document.getElementById("textInput"),n=document.getElementById("compressCheckbox"),o=document.getElementById("closeCodeContainer");if(!t||!e||!n||!o)return;let a=parseInt(t.value),s=a>=8,i=a===8;if(o.style.display=i?"flex":"none",s&&!i){e.disabled=!0,e.classList.add("disabled"),e.placeholder="Ping/Pong frames don't have a payload",e.value="",n.disabled=!0,n.parentElement.classList.add("disabled");let r=document.getElementById("finCheckbox");r&&(r.checked=!0,r.disabled=!0,r.parentElement.classList.add("disabled"))}else{e.disabled=!1,e.classList.remove("disabled"),i?(e.placeholder="Close reason (optional)",e.value=""):(e.placeholder="Your message goes here",e.value=""),n.disabled=!1,n.parentElement.classList.remove("disabled");let r=document.getElementById("finCheckbox");r&&(r.disabled=!1,r.parentElement.classList.remove("disabled"))}}async function R(){let t=document.getElementById("textInput"),e=document.getElementById("output"),n=document.getElementById("frameDetails"),o=document.getElementById("opSelect"),a=document.getElementById("closeCodeSelect"),s=document.getElementById("finCheckbox"),i=document.getElementById("maskCheckbox"),r=document.getElementById("compressCheckbox");if(!t||!o||!s||!i||!r||!e){console.error("UI elements not found");return}n.innerHTML="";try{let u=t.value||"",m=parseInt(o.value),d=m===8,p=m<8;if(p&&u.length>1e5)throw new Error("Plaintext input is too long. Maximum length is 100,000 characters.");let c,l=null;if(d){if(l=parseInt(a.value)||1e3,l<1e3||l>1015)throw new Error("Invalid close code. Must be between 1000-1015.");let b=new Uint8Array(2);if(b[0]=l>>8&255,b[1]=l&255,u!==""){let N=new TextEncoder().encode(u);c=new Uint8Array(2+N.length),c.set(b,0),c.set(N,2)}else c=b}else p?c=new TextEncoder().encode(u):c=new Uint8Array(0);let y={payload:c,opcode:m,fin:s.checked,rsv1:r.checked,rsv2:!1,rsv3:!1,masked:i.checked,compressed:r.checked,closeCode:l},h=await T(y);v=h,e.innerHTML="";let g=j(h.frameSections);e.append(g.container),Z(h.frameSections)}catch(u){let m=document.createElement("div");m.className="error-message",m.textContent=u.message,n.append(m)}}var ee=[{value:"0",text:"Continuation (0x0)",description:"Continues a fragmented message started by a previous frame"},{value:"1",text:"Text (0x1)",description:"UTF-8 encoded text data"},{value:"2",text:"Binary (0x2)",description:"Binary data"},{value:"8",text:"Close (0x8)",description:"Connection close with optional code and reason"},{value:"9",text:"Ping (0x9)",description:"Ping (no payload)"},{value:"10",text:"Pong (0xA)",description:"Pong (no payload)"}],te=[{value:"1000",text:"1000 Normal Closure",description:"Normal closure, meaning that the purpose for which the connection was established has been fulfilled."},{value:"1001",text:"1001 Going Away",description:'An endpoint is "going away", such as a server going down or a browser having navigated away from a page.'},{value:"1002",text:"1002 Protocol Error",description:"An endpoint is terminating the connection due to a protocol error."},{value:"1003",text:"1003 Unsupported Data",description:"An endpoint is terminating the connection because it has received a type of data it cannot accept."},{value:"1005",text:"1005 No Status Received",description:"No status code was actually present."},{value:"1006",text:"1006 Abnormal Closure",description:"Abnormal closure, meaning the connection was lost without a close frame being received."},{value:"1007",text:"1007 Invalid frame payload data",description:"An endpoint is terminating the connection because it has received data within a message that was not consistent with the type of the message."},{value:"1008",text:"1008 Policy Violation",description:'An endpoint is terminating the connection because it has received a message that "violates its policy".'},{value:"1009",text:"1009 Message too big",description:"An endpoint is terminating the connection because it has received a message that is too big for it to process."},{value:"1010",text:"1010 Extension Required",description:"An endpoint (client) is terminating the connection because it has expected the server to negotiate one or more extension."},{value:"1011",text:"1011 Internal Error",description:"A server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request."},{value:"1015",text:"1015 TLS Handshake",description:"The connection was closed due to a failure to perform a TLS handshake."}],M=document.getElementById("encoder");function ne(){let t=document.createElement("div");t.className="container",t.id="container";let e=document.createElement("div");e.className="left-panel",e.id="inputPanel";let n=document.createElement("div");return n.className="right-panel",n.id="rightPanel",t.append(e),t.append(n),{container:t,leftPanel:e,rightPanel:n}}function ae(){let t=document.createElement("textarea");return t.className="text-input",t.id="textInput",t.placeholder="Your message goes here",t}function oe(){let t=document.createElement("div");t.className="options";let e=document.createElement("label");e.textContent="Frame type",e.htmlFor="opSelect",e.className="op-label";let n=document.createElement("select");n.className="op-select",n.id=e.htmlFor,n.addEventListener("change",F),ee.forEach(c=>{let l=document.createElement("option");l.value=c.value,l.textContent=c.text,l.title=c.description,n.append(l)}),n.value="1";let o=document.createElement("div");o.className="op-container",o.id="opContainer",o.append(e,n);let a=document.createElement("label");a.textContent="Close code",a.htmlFor="closeCodeSelect",a.className="close-code-label",a.id="closeCodeLabel";let s=document.createElement("select");s.className="close-code-select",s.id=a.htmlFor,te.forEach(c=>{let l=document.createElement("option");l.value=c.value,l.textContent=c.text,l.title=c.description,s.append(l)});let i=document.createElement("div");i.className="close-code-container",i.id="closeCodeContainer",i.style.display="none",i.append(a,s);let r=document.createElement("div");r.className="checkbox-container";let u=I("FIN bit",!0,"finCheckbox"),m=I("Masked frame",!0,"maskCheckbox"),d=I("Enable compression",!1,"compressCheckbox");r.append(u.container,m.container,d.container);let p=document.createElement("button");return p.textContent="Generate WebSocket Frame",p.className="generate-btn",p.onclick=R,t.append(o),t.append(i),t.append(r),t.append(p),t}function se(){let t=document.createElement("div");t.className="output",t.id="output";let e=document.createElement("div");return e.className="output-placeholder",e.textContent="Frame bytes appear here",t.append(e),t}function ce(){let t=document.createElement("div");t.id="frameDetails",t.className="frame-details";let e=document.createElement("div");return e.className="details-placeholder",e.textContent="Frame details appear here",t.append(e),t}function ie(){let{container:t,leftPanel:e,rightPanel:n}=ne(),o=ae(),a=se(),s=oe(),i=ce();e.append(o),e.append(s),e.append(a),n.append(i),M.style.padding="10px",M.append(t)}ie();})();
